var mysql=require('mysql');

function connectServer(){

    var client=mysql.createConnection({
        host:'192.168.0.254',
        user:'tataufo',
        password:'Inno3pku',
        database:'test_gc1'
    })

    return client;
}


function  getUser(client,username,callback){
    //client为一个mysql连接对象
    client.query('select password from tb_user where username="'+username+'"',function(err,results,fields){
        if(err) throw err;

        callback(results);
    });
}

function insertUser(client , username , password,callback){
    console.log( username + password);
    client.query('insert into tb_user (username,password)values (?,?)', [username, password], function(err,result){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
          callback(err);
    });
}

function  getDeviceList(client, village_id, callback){
    //client为一个mysql连接对象
    client.query('select device_id,device_pos,device_name,V_level,pos_x,pos_y from tb_device where village_id='+village_id ,function(err,results,fields){
       if( err ){
            console.log( "error:" + err.message);
            return err;
        }
       //  console.log( "results:" + results);
        callback(results);
    });
}

function  getDevice(client, device_id, callback){
    //client为一个mysql连接对象
    client.query('select device_id,device_pos,device_name,V_level,pos_x,pos_y,village_id from tb_device where device_id='+device_id ,function(err,results,fields){
       if( err ){
            console.log( "error:" + err.message);
            return err;
        }
       //console.log( "results:" + results);
        callback(results);
    });
}

function addDevice(client,village_id ,device_name,device_pos_x,device_pos_y, callback) {
    client.query('insert into tb_device (device_name,village_id,pos_x,pos_y) values (?,?,?,?)', 
        [device_name, village_id, device_pos_x, device_pos_y],function(err,results){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        } 
         callback(err);
    });
}

function updateDevice(client,device_id ,device_name,device_pos_x,device_pos_y, callback) {
    client.query('update  tb_device set device_name=?,pos_x=?,pos_y=? where device_id=?', 
        [device_name, device_pos_x, device_pos_y, device_id],function(err,results){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        } 
         callback(err);
    });
}


function  getModuleList(client, device_id, callback){
    //client为一个mysql连接对象
    client.query('select module_id,module_name,module_type,module_pos,producer,DATE_FORMAT(running_date,"%Y-%m-%d") as running_date,'
        + 'DATE_FORMAT(verify_date,"%Y-%m-%d") as verify_date,version,verify_code,net_address,bianbi,dingzhidanhao,tb_device.device_id ,tb_device.device_name,tb_device.village_id '
        + 'from tb_module left join tb_device on tb_device.device_id=tb_module.device_id where tb_module.device_id='
        + device_id ,function(err,results,fields){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
       console.log( "results:" + results);
        callback(results);
    });
}

function  getModule(client, module_id, callback){
    //client为一个mysql连接对象
    client.query('select module_id,module_name,module_type,module_pos,producer,DATE_FORMAT(running_date,"%Y-%m-%d") as running_date,'
        + 'DATE_FORMAT(verify_date,"%Y-%m-%d") as verify_date,version,verify_code,net_address,bianbi,dingzhidanhao,tb_device.device_id ,tb_device.device_name '
        + 'from tb_module left join tb_device on tb_device.device_id=tb_module.device_id where tb_module.module_id='
        + module_id ,function(err,results,fields){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
       console.log( "results:" + results);
        callback(results);
    });
}

function  getVillageList(client, county_id, callback){
    //client为一个mysql连接对象
    client.query('select village_id, village_name,V_level from tb_village where county_id='+county_id ,function(err,results,fields){
        if(err) throw err;

        callback(results);
    });
}

function  updateModule(client, module_id, module_name,module_type,producer,running_date,
       verify_date,version,verify_code,net_address,bianbi,dingzhidanhao, callback){
    //client为一个mysql连接对象
    sql = 'update tb_module set '
    if (module_name){
        sql = sql + ' module_name=' + module_name + ','
    }
    
    if (module_type){
        sql = sql + ' module_type=' + module_type + ','
    }

    if (producer){
        sql = sql + ' producer=' + producer + ','
    }
    if (running_date){
        sql = sql + ' running_date=' + running_date + ','
    }
    if (verify_date){
        sql = sql + ' verify_date=' + verify_date + ','
    }
    if (version){
        sql = sql + ' version=' + version + ','
    }
    if (verify_code){
        sql = sql + ' verify_code=' + verify_code + ','
    }
    if (net_address){
        sql = sql + ' net_address=' + net_address + ','
    }

    sql = sql.substr(0,sql.length-1) + ' where module_id=' + module_id;
  
       //'bianbi=' + bianbi +
        //'dingzhidanhao=' + dingzhidanhao + 'where module_id=' + module_id;
    console.log(sql);
    client.query(sql, function(err,results,fields){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}


function  insertModule(client, device_id,module_name,module_type,producer,running_date,
       verify_date,version,verify_code,net_address,bianbi,dingzhidanhao, callback){
    //client为一个mysql连接对象
    sql = 'insert into tb_module (module_name,module_type,producer,running_date,verify_date,version,verify_code,net_address,device_id)'
        + 'values ("' + module_name + '","' + module_type + '","' + producer + '","' + running_date
        + '","' + verify_date + '",' + version + ',' + verify_code + ',"' + net_address + '","' + device_id + '")';

    
    console.log(sql);
    client.query(sql, function(err,results,fields){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}

exports.connect = connectServer;
exports.getUser  = getUser;
exports.insertUser = insertUser;
exports.getDevice = getDevice;
exports.getDeviceList = getDeviceList;
exports.getModuleList = getModuleList;
exports.getVillageList = getVillageList;
exports.getModule = getModule;
exports.updateModule = updateModule;
exports.insertModule = insertModule;
exports.addDevice = addDevice;
exports.updateDevice = updateDevice;
